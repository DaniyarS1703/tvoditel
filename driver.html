<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–õ–ö –í–æ–¥–∏—Ç–µ–ª—è</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <header class="header">
    <button class="small-button btn-back" onclick="location.href='/'">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="city">–ê–ª–º–∞—Ç—ã</div>
  </header>

  <main>
    <div class="profile">
      <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–¥–∏—Ç–µ–ª—è</h2>
      <img id="avatar-img" src="https://via.placeholder.com/80" alt="–ê–≤–∞—Ç–∞—Ä">
      <input id="driver-avatar" type="file" accept="image/*" onchange="previewAvatar(event)">
      <input id="driver-id" type="text" placeholder="Telegram ID" readonly>
      <input id="driver-name" type="text" placeholder="–ò–º—è">
      <input id="driver-city" type="text" placeholder="–ì–æ—Ä–æ–¥" value="–ê–ª–º–∞—Ç—ã">
      <button onclick="saveDriver()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <div id="driver-save-status" class="save-status"></div>
    </div>

    <div class="status-row">
      <h2>–°—Ç–∞—Ç—É—Å –¥–æ—Å—Ç—É–ø–∞</h2>
      <div class="driver-status-block">
        <span id="access-status" class="driver-status-active">–î–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–µ–Ω</span>
        <button class="status-refresh-btn" onclick="refreshStatus()" title="–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å">üîÑ</button>
      </div>
    </div>

    <div class="orders">
      <h2>–°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤</h2>
      <div id="driver-orders"><p>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p></div>
    </div>
  </main>

  <script>
    // Telegram SDK
    const tg = window.Telegram && window.Telegram.WebApp;

    function tryFillDriverID() {
      let id = '';
      // 1. –ò–∑ initDataUnsafe
      if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
        id = tg.initDataUnsafe.user.id;
      }
      // 2. –ò–ª–∏ –∏–∑ localStorage
      else if (localStorage.getItem('tg_init')) {
        try {
          const data = JSON.parse(localStorage.getItem('tg_init'));
          if (data.user && data.user.id) id = data.user.id;
        } catch(e){}
      }
      // 3. –í—Å—Ç–∞–≤–ª—è–µ–º
      if (id) {
        document.getElementById('driver-id').value = id;
      } else {
        document.getElementById('driver-id').placeholder = '–ù–µ—Ç ID (–∑–∞–ø—É—Å—Ç–∏ —á–µ—Ä–µ–∑ Telegram)';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (tg) tg.expand();
      tryFillDriverID();
      loadDriverOrders();
      loadDriverStatus();
    });

    function previewAvatar(e) {
      const reader = new FileReader();
      reader.onload = () => document.getElementById('avatar-img').src = reader.result;
      reader.readAsDataURL(e.target.files[0]);
    }

    function saveDriver() {
      const form = new FormData();
      form.append('tg_id', document.getElementById('driver-id').value);
      form.append('name',  document.getElementById('driver-name').value.trim());
      form.append('city',  document.getElementById('driver-city').value.trim());
      const file = document.getElementById('driver-avatar').files[0];
      if (file) form.append('avatar', file);

      fetch('/api/drivers', { method:'POST', body: form })
        .then(res=>res.json())
        .then(()=>{
          const status = document.getElementById('driver-save-status');
          status.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
          setTimeout(()=>status.textContent = '', 2000);
        })
        .catch(()=> alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'));
    }

    function loadDriverOrders() {
      fetch('/api/orders')
        .then(r=>r.json())
        .then(data=>{
          const c = document.getElementById('driver-orders');
          if (!data.length) return c.innerHTML = '<p>–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</p>';
          c.innerHTML = data.map(o=>`
            <div class="order-item">
              <strong>${o.name}</strong> (${o.phone})<br>
              ${o.car_model} ‚Äî ${o.route}<br>
              <em>${o.price}¬†‚Ç∏</em>
            </div>
          `).join('');
        });
    }

    // –ö—Ä–∞—Å–∏–≤—ã–π —Å—Ç–∞—Ç—É—Å
    function loadDriverStatus() {
      setDriverStatus('active');
    }
    function refreshStatus() {
      setDriverStatus('active');
      const btn = document.querySelector('.status-refresh-btn');
      btn.classList.add('spin');
      setTimeout(()=>btn.classList.remove('spin'), 600);
    }
    function setDriverStatus(status) {
      const el = document.getElementById('access-status');
      if (status === 'active') {
        el.textContent = '–î–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–µ–Ω';
        el.className = 'driver-status-active';
      } else {
        el.textContent = '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
        el.className = 'driver-status-inactive';
      }
    }
  </script>
</body>
</html>
