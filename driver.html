<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –≤–æ–¥–∏—Ç–µ–ª—è</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* ... –≤—Å–µ —Ç–≤–æ–∏ —Å—Ç–∏–ª–∏ ... */
    /* --- –¥–æ–±–∞–≤—å —Å—é–¥–∞ —Ç–≤–æ–π CSS –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π --- */
  </style>
</head>
<body>
  <header class="header">
    <button class="small-button btn-back" onclick="location.href='/'">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="city">–ê–ª–º–∞—Ç—ã</div>
  </header>
  <main>
    <div class="profile">
      <h2 id="profile-title">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –≤–æ–¥–∏—Ç–µ–ª—è</h2>
      <div id="profile-view" class="profile-view" style="display:none;">
        <img id="avatar-img" src="https://via.placeholder.com/80" alt="–ê–≤–∞—Ç–∞—Ä">
        <div class="profile-name" id="profile-name"></div>
        <div class="profile-city" id="profile-city"></div>
        <div class="driver-status-block">
          <span id="access-status" class="driver-status-active">–î–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–µ–Ω</span>
          <button class="status-refresh-btn" onclick="refreshStatus()" title="–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å">üîÑ</button>
        </div>
        <button class="profile-edit-btn" onclick="editProfile()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <form id="profile-form" class="profile-form" style="display:none;" onsubmit="event.preventDefault();saveDriver();">
        <input id="driver-id"     type="text" placeholder="Telegram ID" readonly>
        <input id="driver-name"   type="text" placeholder="–ò–º—è" required>
        <input id="driver-city"   type="text" placeholder="–ì–æ—Ä–æ–¥" value="–ê–ª–º–∞—Ç—ã" required>
        <!-- –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä —Ñ–æ—Ç–æ –ø–æ–¥ –∞–≤–∞—Ç–∞—Ä–∫–æ–π -->
        <div style="text-align:center; margin-bottom:12px;">
          <img id="form-avatar-img" src="https://via.placeholder.com/80" alt="–ê–≤–∞—Ç–∞—Ä" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid #bbe2fa;">
          <br>
          <input id="driver-avatar" type="file" accept="image/*" style="margin-top:7px;" onchange="previewAvatarForm(event)">
        </div>
        <div class="btns-row">
          <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button type="button" onclick="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <div id="driver-save-status" class="save-status-bar"></div>
      </form>
    </div>
    <div id="orders-block" class="orders" style="display:none;">
      <h2>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h2>
      <div id="driver-orders"><p>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p></div>
    </div>
  </main>
  <script>
    let currentProfile = null;
    if (window.Telegram?.WebApp) window.Telegram.WebApp.expand();

    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const uid = params.get('user_id') || localStorage.getItem('tg_user_id') || '1234567890';
      document.getElementById('driver-id').value = uid;
      loadDriverProfile(uid);
      loadDriverStatus();
    });

    function loadDriverProfile(uid) {
      fetch('/api/drivers')
        .then(res => res.json())
        .then(drivers => {
          const driver = drivers.find(d => d.tg_id == uid);
          currentProfile = driver;
          if (driver) {
            showProfileView(driver);
            document.getElementById('orders-block').style.display = 'block';
            loadDriverOrders();
          } else {
            showProfileEdit(true);
            document.getElementById('orders-block').style.display = 'none';
          }
        });
    }

    function showProfileView(driver) {
      document.getElementById('profile-form').style.display = 'none';
      document.getElementById('profile-view').style.display = 'block';
      document.getElementById('profile-title').textContent = '–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –≤–æ–¥–∏—Ç–µ–ª—è';
      document.getElementById('profile-name').textContent = driver.name || '';
      document.getElementById('profile-city').textContent = driver.city || '–ê–ª–º–∞—Ç—ã';
      document.getElementById('avatar-img').src = driver.avatar || 'https://via.placeholder.com/80';
    }

    function showProfileEdit(isFirstReg=false) {
      document.getElementById('profile-form').style.display = 'block';
      document.getElementById('profile-view').style.display = 'none';
      document.getElementById('profile-title').textContent = isFirstReg ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–¥–∏—Ç–µ–ª—è' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è';
      // –ï—Å–ª–∏ —É–∂–µ –±—ã–ª –ø—Ä–æ—Ñ–∏–ª—å ‚Äî –∑–∞–ø–æ–ª–Ω—è–µ–º
      if (currentProfile) {
        document.getElementById('driver-name').value = currentProfile.name || '';
        document.getElementById('driver-city').value = currentProfile.city || '–ê–ª–º–∞—Ç—ã';
        document.getElementById('form-avatar-img').src = currentProfile.avatar || 'https://via.placeholder.com/80';
      } else {
        document.getElementById('driver-name').value = '';
        document.getElementById('driver-city').value = '–ê–ª–º–∞—Ç—ã';
        document.getElementById('form-avatar-img').src = 'https://via.placeholder.com/80';
      }
    }

    function previewAvatarForm(e) {
      const reader = new FileReader();
      reader.onload = ()=> document.getElementById('form-avatar-img').src = reader.result;
      reader.readAsDataURL(e.target.files[0]);
    }

    function editProfile() { showProfileEdit(); }
    function cancelEdit() { showProfileView(currentProfile); clearSaveStatus(); }

    async function saveDriver() {
      const form = new FormData();
      form.append('tg_id', document.getElementById('driver-id').value);
      form.append('name',  document.getElementById('driver-name').value.trim());
      form.append('city',  document.getElementById('driver-city').value.trim());
      const file = document.getElementById('driver-avatar').files[0];
      if (file) form.append('avatar', file);

      try {
        const res = await fetch('/api/drivers', { method:'POST', body: form });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); }
        catch(e) { throw new Error('–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON: ' + e.message); }
        if (data.status === 'ok') {
          showSaveStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
          setTimeout(clearSaveStatus, 2500);
          loadDriverProfile(document.getElementById('driver-id').value);
        } else {
          throw new Error('–°—Ç–∞—Ç—É—Å != ok: ' + JSON.stringify(data));
        }
      } catch(err) {
        showSaveStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + err.message, true);
      }
    }

    function showSaveStatus(msg, error=false) {
      const el = document.getElementById('driver-save-status');
      el.textContent = msg;
      el.style.background = error ? '#ffe3e3' : '#e2ffe6';
      el.style.color = error ? '#be2727' : '#24b450';
      el.classList.remove('hide');
    }
    function clearSaveStatus() {
      const el = document.getElementById('driver-save-status');
      el.textContent = '';
      el.classList.add('hide');
    }

    function loadDriverOrders() {
      fetch('/api/orders')
        .then(r => r.json())
        .then(data => {
          const c = document.getElementById('driver-orders');
          if (!data.length) return c.innerHTML = '<p>–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</p>';
          c.innerHTML = data.map(o=>`
            <div class="order-item">
              <strong>${o.name}</strong> (${o.phone})<br>
              ${o.car_model} ‚Äî ${o.route}<br>
              <em>${o.price}¬†‚Ç∏</em>
            </div>
          `).join('');
        });
    }

    function loadDriverStatus() { setDriverStatus('active'); }
    function refreshStatus() {
      setDriverStatus('active');
      const btn = document.querySelector('.status-refresh-btn');
      btn.classList.add('spin');
      setTimeout(()=>btn.classList.remove('spin'), 600);
    }
    function setDriverStatus(status) {
      const el = document.getElementById('access-status');
      if (status === 'active') {
        el.textContent = '–î–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–µ–Ω';
        el.className = 'driver-status-active';
      } else {
        el.textContent = '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
        el.className = 'driver-status-inactive';
      }
    }
  </script>
</body>
</html>
